<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.NYA_calculation.repository.DetailRepository">

    <select id="getMonthlyTotal" resultType="com.example.NYA_calculation.dto.ExpenseSummary">
        SELECT
        DATE_FORMAT(billing_date, '%Y-%m') AS month,
        SUM(amount) AS totalAmount
        FROM
        details
        GROUP BY
        DATE_FORMAT(billing_date, '%Y-%m')
        ORDER BY
        month
    </select>
    <insert id="insert" parameterType="com.example.NYA_calculation.repository.entity.Detail" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO details (
            billing_date,
            round_trip,
            amount,
            subtotal,
            reason,
            transportation,
            file_name,
            slip_id,
            remark,
            user_id,
            created_date,
            updated_date
        )
        VALUES (
            #{billingDate},
            #{roundTrip},
            #{amount},
            #{subtotal},
            #{reason},
            #{transportation},
            #{fileName},
            #{slipId},
            #{remark},
            #{userId},
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP
        )
    </insert>
    <!-- 明細取得（slip_id指定） -->
    <select id="findBySlipId" parameterType="int"
            resultType="com.example.NYA_calculation.repository.entity.Detail">
        SELECT
        d.id,
        d.billing_date,
        d.round_trip,
        d.amount,
        d.subtotal,
        d.reason,
        d.transportation,
        d.file_name,
        d.remark,
        d.created_date,
        d.updated_date
        FROM details d
        WHERE d.slip_id = #{slipId}
        ORDER BY d.billing_date DESC
    </select>
    <update id="update" parameterType="com.example.NYA_calculation.repository.entity.Detail">
        UPDATE details
        SET
        billing_date = #{billingDate},
        round_trip = #{roundTrip},
        amount = #{amount},
        subtotal = #{subtotal},
        reason = #{reason},
        transportation = #{transportation},
        file_name = #{fileName},
        remark = #{remark},
        updated_date = NOW()
        WHERE id = #{id}
    </update>

</mapper>